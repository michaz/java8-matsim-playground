BASE=output
SAMPLE=0.1

berlin/uncongested3/output-berlin <- !input/berlin/2kW.15.xml
	mvn -pl matsim-playground exec:java -Dexec.cleanupDaemonThreads=false -Dexec.mainClass="berlin.BerlinRunUncongested3" -Dexec.args="$SAMPLE $INPUT $OUTPUT"

histogram() [R]
	library("ggplot2")
	truth <- read.table(paste0('$[INPUT0]',"/ITERS/it.0/perso-dist-histo.txt",sep=""), header=TRUE)
	truth <- within(truth, case<-"truth")
	initial <- read.table(paste0('$[INPUT1]',"/ITERS/it.0/perso-dist-histo.txt",sep=""), header=TRUE)
	initial <- within(initial, case<-"initial")
	calibrated <- read.table(paste0('$[INPUT1]',"/ITERS/it.100/perso-dist-histo.txt",sep=""), header=TRUE)
    calibrated <- within(calibrated, case<-"calibrated")
	all <- rbind(truth, initial, calibrated)
    all <- within(all, case <- factor(case, levels=(c("initial", "calibrated", "truth"))))
    ggplot(subset(all, distance < 200000), aes(x=distance/1000, fill=case)) +
    	geom_histogram(position="dodge") +
    	theme_bw() +
    	labs(x = "All-day travel distance [km]", y = "Number of Inviduals", fill = "Case") +
    	scale_fill_manual(values=c("grey70", "grey50", "black")) +
    	theme(legend.position="bottom")
    write.table(all, file='$[OUTPUT0]', row.names=FALSE)
    ggsave('$[OUTPUT1]')

berlin/uncongested3/travel-distance-histo-random.txt, berlin/uncongested3/travel-distance-histo-random.pdf <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/random-heavy-users/alternatives/full-procedure/run [method:histogram]
berlin/uncongested3/travel-distance-histo-random-with-histogram.txt, berlin/uncongested3/travel-distance-histo-random-with-histogram.pdf <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/random-heavy-users/alternatives/full-procedure-with-histogram/run [method:histogram]

run_simulation()
    mvn -pl matsim-playground exec:java -Dexec.mainClass="populationsize.RunSimulation" -Dexec.args="$ALTERNATIVE $INPUT0 $INPUT1 $OUTPUT"
    mvn -pl matsim-playground exec:java -Dexec.mainClass="cdr.PersoDistHistoModule" -Dexec.args="$OUTPUT 0"
    mvn -pl matsim-playground exec:java -Dexec.mainClass="cdr.PersoDistHistoModule" -Dexec.args="$OUTPUT 100"

ALTERNATIVE=full-procedure
berlin/uncongested3/alternatives/random-heavy-users/alternatives/full-procedure/run <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/random-heavy-users/sightings [method:run_simulation]
berlin/uncongested3/alternatives/worker-heavy-users/alternatives/full-procedure/run <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/worker-heavy-users/sightings [method:run_simulation]

ALTERNATIVE=full-procedure-with-histogram
berlin/uncongested3/alternatives/random-heavy-users/alternatives/full-procedure-with-histogram/run <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/random-heavy-users/sightings [method:run_simulation]

ALTERNATIVE=clone
berlin/uncongested3/alternatives/worker-heavy-users/alternatives/clone/run <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/worker-heavy-users/sightings [method:run_simulation]

berlin/uncongested3/alternatives/random-heavy-users/sightings <- berlin/uncongested3/output-berlin
	mvn -pl matsim-playground exec:java -Dexec.mainClass="populationsize.RunRandomHeavyUsers" -Dexec.args="$SAMPLE $INPUT $OUTPUT"
berlin/uncongested3/alternatives/random-heavy-users/alternatives/full-procedure-with-histogram/en-route.pdf <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/random-heavy-users/alternatives/full-procedure-with-histogram/run
	Rscript en-route.R $INPUT0 $INPUT1 $OUTPUT

berlin/uncongested3/alternatives/worker-heavy-users/sightings <- berlin/uncongested3/output-berlin
	mvn -pl matsim-playground exec:java -Dexec.mainClass="populationsize.RunWorkerNonWorker" -Dexec.args="$INPUT $OUTPUT"
berlin/uncongested3/alternatives/worker-heavy-users/alternatives/full-procedure/en-route.pdf <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/worker-heavy-users/alternatives/full-procedure/run
	Rscript en-route.R $INPUT0 $INPUT1 $OUTPUT
berlin/uncongested3/alternatives/worker-heavy-users/alternatives/clone/en-route.pdf <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/worker-heavy-users/alternatives/clone/run
	Rscript en-route.R $INPUT0 $INPUT1 $OUTPUT

%trajectorySimilarityApp <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/worker-heavy-users/sightings
	mvn -pl matsim-playground exec:java -Dexec.mainClass="fx.TrajectorySimilarityApp" -Dexec.args="--baseRunDir=$INPUT0 --sightingsDir=$INPUT1"
berlin/uncongested3/alternatives/worker-heavy-users/trajectory-similarity-figures <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/worker-heavy-users/sightings
	mvn -pl matsim-playground exec:java -Dexec.mainClass="fx.RunTrajectorySimilarityFigures" -Dexec.args="--baseRunDir=$INPUT0 --sightingsDir=$INPUT1 --output=$OUTPUT --sparse=17167184 --dense=16159661"

berlin/uncongested3/alternatives/only-heavy-users/sightings <- berlin/uncongested3/output-berlin
	mvn -pl matsim-playground exec:java -Dexec.mainClass="populationsize.RunOnlyHeavyUsers" -Dexec.args="$INPUT $OUTPUT"
berlin/uncongested3/alternatives/only-heavy-users/alternatives/segmentation-only/run <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/only-heavy-users/sightings
	mvn -pl matsim-playground exec:java -Dexec.mainClass="segmenttraces.RunTrajectorySegmentationOnly" -Dexec.args="$INPUT0 $INPUT1 $OUTPUT"
berlin/uncongested3/alternatives/only-heavy-users/alternatives/segmentation-only/activity-structure.png <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/only-heavy-users/sightings, berlin/uncongested3/alternatives/only-heavy-users/alternatives/segmentation-only/run
	mvn -pl matsim-playground exec:java -Dexec.mainClass="segmenttraces.RunActivityStructure" -Dexec.args="$INPUT0 $INPUT1 $INPUT2 $OUTPUT"
berlin/uncongested3/alternatives/only-heavy-users/alternatives/segmentation-only/activity-structure-distance.png <- berlin/uncongested3/output-berlin, berlin/uncongested3/alternatives/only-heavy-users/alternatives/segmentation-only/run
	mvn -pl matsim-playground exec:java -Dexec.mainClass="segmenttraces.RunActivityStructureDistance" -Dexec.args="--baseRunDir=$INPUT0 --runDir=$INPUT1 --output=$OUTPUT"

berlin/congested3/output-berlin <- !input/berlin/2kW.15.xml
	mvn -pl matsim-playground exec:java -Dexec.mainClass="berlin.BerlinRunCongested3" -Dexec.args="$SAMPLE $INPUT $OUTPUT"

berlin/congested3/alternatives/only-heavy-users/sightings <- berlin/congested3/output-berlin
	mvn -pl matsim-playground exec:java -Dexec.mainClass="populationsize.RunOnlyHeavyUsers" -Dexec.args="$INPUT $OUTPUT"

%legHistogramApp <- berlin/uncongested3/output-berlin
	mvn -pl matsim-playground exec:java -Dexec.mainClass="fx.LegHistogramApp" -Dexec.args="--runDir=$INPUT"

guice1 <- !input/graphconfig.xml
	mvn -pl matsim-playground exec:java -Dexec.mainClass="guice.Graph" -Dexec.args="$INPUT guice.MyModule $OUTPUT"
guice1.svg <- guice1
	dot -Tsvg -o$OUTPUT $INPUT/guice.dot
guice1.pdf <- guice1
	dot -Tpdf -o$OUTPUT $INPUT/guice.dot

guice <- !input/graphconfig.xml
	mvn -pl matsim-playground exec:java -Dexec.mainClass="guice.Graph2" -Dexec.args="$INPUT guice.MyModule $OUTPUT"
guice.svg <- guice
	dot -Tsvg -o$OUTPUT $INPUT/guice.dot
guice.pdf <- guice
	dot -Tpdf -o$OUTPUT $INPUT/guice.dot

